# TEMPLATE.YAML
# AUTHOR: kito129

# SENSORS
- sensor:
    # HOME TOTAL
    # POWER
    - name: "home_total_power"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-623518c3497h"
      device_class: power
      state_class: measurement
      unit_of_measurement: "W"
      icon: mdi:lightning-bolt
      state: >-
        {{ ( float(states('sensor.enel_power')) + float(states('sensor.solar_power'))) | round(2) }}

    # ENERGY
    - name: "home_total_energy"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-606518c3497a"
      device_class: energy
      state_class: total_increasing
      unit_of_measurement: "kWh"
      icon: mdi:home-lightning-bolt-outline
      state: >-
        {{ ( float(states('sensor.enel_energy')) + float(states('sensor.solar_energy')) - float(states('sensor.enel_energy_returned'))) | round(2) }}

    # OTHER LOADS
    # POWER
    - name: "home_other_loads_power"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-607618c3497h"
      device_class: power
      state_class: measurement
      unit_of_measurement: "W"
      icon: mdi:meter-electric
      state: >-
        {% if is_state('switch.ininverter', "on") -%} 
          {{ ( float(states('sensor.home_power')) - float(states('sensor.kitchen_power')) - float(states('sensor.battery_in_power')) - float(states('sensor.monitor_power')) ) | round(2) }}
        {%- else -%}
         {{ ( float(states('sensor.home_power')) - float(states('sensor.kitchen_power')) - float(states('sensor.monitor_power')) ) | round(2) }}
        {%- endif %}



    # HOME
    - name: "home_other_loads_energy"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-606518c3497c"
      device_class: energy
      state_class: total_increasing
      unit_of_measurement: "kWh"
      icon: mdi:home-battery
      state: >-
        {{ ( float(states('sensor.home_energy')) - float(states('sensor.kitchen_energy'))) | round(2) }}

    # ENEL NET ENERGY
    - name: "enel_net_energy"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-606458c3497h"
      device_class: energy
      state_class: total_increasing
      unit_of_measurement: "kWh"
      icon: mdi:transmission-tower
      state: >-
        {{ ( float(states('sensor.enel_energy')) - float(states('sensor.enel_energy_returned'))) | round(2) }}

    # BATTERY

    # BATTERY IN POWER
    - name: "battery_in_power"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-606518c3497h"
      device_class: power
      state_class: measurement
      unit_of_measurement: "W"
      icon: mdi:battery-arrow-up
      state: >-
        {% if is_state('switch.ininverter', "on") -%}
          {{ states('sensor.ininverter_power') }}
        {%- else -%}
          0
        {%- endif %}

    # BATTERY OUT POWER
    - name: "battery_out_power"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-604518c3497h"
      device_class: power
      state_class: measurement
      unit_of_measurement: "W"
      icon: mdi:battery-arrow-down
      state: >-
        {% if is_state('switch.switch', "on") -%}
          {{ ( float(states('sensor.acsala_power')) + float(states('sensor.acscala_power'))) | round(2) }}
        {%- else -%}
          {{ ( float(0) | round(2)) }}
        {%- endif %}

      # BATTERY NET
    - name: "battery_net_power"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-456518c3497h"
      device_class: power
      state_class: measurement
      unit_of_measurement: "W"
      icon: mdi:battery
      state: >-
        {{ ( float(states('sensor.battery_in_power')) + float(states('sensor.battery_out_power')) ) | round(2) }}


    # BOILER ROOM POWER
    - name: "boiler_room_power"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-456518c5858"
      device_class: power
      state_class: measurement
      unit_of_measurement: "W"
      icon: mdi:water-boiler
      state: >-
        {{ ( float(states('sensor.boiler_power')) + float(states('sensor.washmachine_power')) ) | round(2) }}

    # INDIVIDUAL DEVICES

    # WASHDISHER POWER
    - name: "washdisher_power"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-6045582828"
      device_class: power
      state_class: measurement
      unit_of_measurement: "kW"
      icon: mdi:dishwasher
      state: >-
        {% if is_state('sensor.dishwasher_operation_state', "Run") -%}
          {{ ( float(states('sensor.kitchen_power')) / 1000) | round(2) }}
        {%- else -%}
          {% if is_state('sensor.dishwasher_operation_state', "Ready") -%}
            {{ ( float(states('sensor.kitchen_power')) / 1000) | round(2) }}
          {%- else -%}
            {{ ( float(0) | round(2)) }}
          {%- endif %}
        {%- endif %}

    # OVEN & FRIGO POWER
    - name: "oven_power"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-456574c5858"
      device_class: power
      state_class: measurement
      unit_of_measurement: "kW"
      icon: mdi:stove
      state: >-
        {{ (( float(states('sensor.kitchen_power')) - float(states('sensor.washdisher_power')) ) /1000 ) | round(2) }}

    # INTERNET

    # FIBER UPTIME
    - name: "fiber_uptime"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-456518hsfrr7"
      device_class: duration
      state_class: measurement
      unit_of_measurement: "d"
      icon: mdi:timeline
      state: >-
        {{ ( float(states('sensor.upnp_igd_uptime')) / float((60*60*24*1000)) ) | round(2) }}

    # INTERNET IN TRAFFIC
    - name: "upnp_gb_received"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-6758768"
      device_class: data_rate
      state_class: total
      unit_of_measurement: "GBit"
      icon: mdi:hart-donut
      state: >-
        {{ ( float(states('sensor.upnp_igd_b_received')) /(8*1000000000) ) | round(2) }}

    # INTERNET OUT TRAFFIC
    - name: "upnp_gb_sent"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-8886587"
      device_class: data_rate
      state_class: total
      unit_of_measurement: "GBit"
      icon: mdi:chart-donut
      state: >-
        {{ ( float(states('sensor.upnp_igd_b_sent')) /(8*1000000000) ) | round(2) }}

    # washer end time
    - name: "lavastoviglie_end_time"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-52846"
      state: >-
        {{ as_timestamp(states('sensor.dishwasher_remaining_program_time')) | timestamp_custom('%H:%M:%S') }}
      icon: "mdi:calendar-clock"


#BINARY SENSORS
- binary_sensor:
    # COMBO 1kSolar AND -1kW enel Power
    - name: "combo_minus05_enel_plus1_solar"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-148965126625289"
      device_class: power
      icon: mdi:sun-compass
      state: >-
        {{  states('binary_sensor.minus_05_kw_enel') and states('binary_sensor.plus_1_kw_solar')  }}


     # COMBO 1kSolar AND -1kW enel Power
    - name: "internet_status"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-284852"
      icon: mdi:web
      state: >-
        {% if states('binary_sensor.upnp_igd_wan_status') == "on" -%}
          "ok"
        {%- else -%}
          "ko"
        {%- endif %}

    # oven status based on power
    - name: "oven_status"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-28466528"
      icon: mdi:stove
      state: >-
        {% if states('sensor.oven_power')|float(0) > 10 -%}
          'on'
        {%- else -%}
          'off'
        {%- endif %}

    # oven status based on power
    - name: "rain_weather_status"
      unique_id: "0a7476cc-d6c1-40ba-8ae1-17848485"
      icon: mdi:rain
      state: >-
        {% if states('sensor.selvahome_precipitation')|float(0) > 0.1 -%}
          'on'
        {%- else -%}
          'off'
        {%- endif %}

